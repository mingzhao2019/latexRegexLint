name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Verify tag matches package.json version
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          PKG=$(node -p "require('./package.json').version")
          if [ "$TAG" != "$PKG" ]; then
            echo "Tag $TAG does not match package.json version $PKG"
            exit 1
          fi

      - name: Generate changelog entry
        id: changelog
        run: |
          TAG="${GITHUB_REF_NAME}"
          DATE="$(date -u +%Y-%m-%d)"
          RELEASE_NOTES_PATH="${RUNNER_TEMP}/release-notes.md"
          echo "RELEASE_NOTES_PATH=${RELEASE_NOTES_PATH}" >> $GITHUB_ENV

          PREV_TAG=$(git tag --sort=version:refname | awk -v tag="$TAG" '$0==tag{print prev; exit} {prev=$0}')
          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..$TAG"
            COMPARE="https://github.com/${GITHUB_REPOSITORY}/compare/${PREV_TAG}...${TAG}"
          else
            RANGE="$TAG"
            COMPARE=""
          fi

          NOTES=$(git log --pretty=format:"- %s (%h)" $RANGE)
          if [ -z "$NOTES" ]; then
            NOTES="- Initial release"
          fi

          BODY="## ${TAG} - ${DATE}\n${NOTES}"
          if [ -n "$COMPARE" ]; then
            BODY="${BODY}\n\n[Full Changelog](${COMPARE})"
          fi

          printf "%b\n" "$BODY" > "${RELEASE_NOTES_PATH}"

      - name: Update CHANGELOG.md
        run: |
          python - <<'PY'
          import os

          entry_path = os.environ.get("RELEASE_NOTES_PATH", "release-notes.md")
          changelog_path = "CHANGELOG.md"

          with open(entry_path, "r", encoding="utf-8") as f:
              entry = f.read().rstrip() + "\n\n"

          if not os.path.exists(changelog_path):
              with open(changelog_path, "w", encoding="utf-8") as f:
                  f.write("# Changelog\n\n")

          with open(changelog_path, "r", encoding="utf-8") as f:
              content = f.read()

          if content.startswith("# Changelog"):
              header, rest = content.split("\n", 1)
              rest = rest.lstrip("\n")
              updated = f"{header}\n\n{entry}{rest}"
          else:
              updated = entry + content

          with open(changelog_path, "w", encoding="utf-8") as f:
              f.write(updated)
          PY

          git checkout main
          git pull --ff-only
          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update CHANGELOG for ${GITHUB_REF_NAME}"
            git push origin HEAD:main
          fi

      - name: Compile
        run: npm run compile

      - name: Package VSIX
        run: |
          mkdir -p dist
          npx vsce package --out dist/latex-regex-lint-${GITHUB_REF_NAME}.vsix

      - name: Publish to Marketplace
        run: npx vsce publish --no-dependencies
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ env.RELEASE_NOTES_PATH }}
          files: dist/*.vsix
